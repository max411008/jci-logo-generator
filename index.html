<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JCI Logo Generator (V8.1 Full Logic)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

    <style>
        /* 載入本地字體 */
        @font-face { 
            font-family: 'Plus Jakarta Sans'; 
            src: url('PlusJakartaSans-Bold.ttf') format('truetype'); 
            font-weight: bold; 
        }

        /* 全局樣式設定 */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            color: #333;
        }

        /* 頂部導航列 */
        .navbar {
            width: 100%; 
            background-color: #0097D7; 
            color: white;
            padding: 16px 0; 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            margin-bottom: 24px;
            position: sticky; 
            top: 0; 
            z-index: 100;
        }

        /* 控制面板區域 */
        .controls { 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
            display: flex; 
            gap: 16px; 
            align-items: flex-end; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            justify-content: center; 
            max-width: 800px; 
            width: 90%;
        }
        
        /* 輸入框群組 */
        .input-group { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            width: 100%; 
            max-width: 250px; 
        }
        
        label { 
            font-size: 13px; 
            font-weight: 700; 
            color: #555; 
            margin-left: 2px; 
        }
        
        input, select { 
            padding: 10px 14px; 
            font-size: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            width: 100%; 
            background-color: #fdfdfd;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: #0097D7; outline: none; }
        
        /* 警告訊息 (Point 4) */
        .warning-msg {
            display: none; 
            color: #dc3545; 
            font-size: 13px; 
            line-height: 1.5;
            margin-top: 6px; 
            background-color: #ffe6e6; 
            padding: 10px 12px;
            border-radius: 6px; 
            border: 1px solid #ffcccc; 
            width: 100%;
            animation: fadeIn 0.3s ease-in-out;
        }
        .warning-divider { border: 0; border-top: 1px dashed #ffb3b3; margin: 6px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* 按鈕群組 */
        .btn-group-vertical { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            width: 100%; 
            max-width: 250px; 
        }

        .btn-base {
            padding: 0 20px; 
            font-size: 15px; 
            font-weight: bold; 
            color: white;
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            height: 44px;
            transition: filter 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            width: 100%;
        }
        .btn-base:hover { filter: brightness(1.1); }
        .btn-base:disabled { background-color: #ccc !important; cursor: not-allowed; filter: none; }

        .btn-png { background-color: #0097D7; box-shadow: 0 4px 10px rgba(0, 151, 215, 0.2); }
        .btn-svg { background-color: #20c997; box-shadow: 0 4px 10px rgba(32, 201, 151, 0.2); }
        .btn-eps { background-color: #6610f2; box-shadow: 0 4px 10px rgba(102, 16, 242, 0.2); }

        /* 預覽區塊 */
        .preview-container { 
            position: relative; 
            width: 550px; 
            padding: 20px; 
            max-width: 95%; 
            border: 1px solid #eee; 
            background-color: #fff; 
            box-sizing: border-box; 
            margin: 0 auto; 
            border-radius: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            /* 允許預覽圖被操作，方便 PNG 截圖 */
            pointer-events: auto; 
        }

        /* Logo 顯示區 */
        .logo-wrapper { position: relative; width: 100%; }
        
        /* 讓預覽區的 SVG 自適應 */
        #svg-preview-box svg { width: 100%; height: auto; display: block; }
        
        /* 隱藏的 Canvas 用於生成圖片 */
        #result-canvas { display: none; }
        #finalResultImg { width: 100%; display: none; border-radius: 4px; margin-top: 20px; border: 2px dashed #0097D7; }

        /* 錯誤訊息框 */
        #error-box {
            display: none;
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: #ffe6e6; color: #c00; padding: 10px; font-size: 12px;
            border: 1px solid #c00; z-index: 999;
        }

        /* 頁尾 */
        .footer { 
            margin-top: auto; padding: 40px 20px; width: 100%; text-align: center; 
            color: #666; font-size: 14px; line-height: 1.8; background-color: #fff; border-top: 1px solid #eee;
        }
        .footer-block { margin-bottom: 15px; } 
        .footer-link {
            color: #333; text-decoration: none; font-weight: bold;
            border-bottom: 1px dotted #999; transition: color 0.2s, border-bottom 0.2s;
        }
        .footer-link:hover { color: #0097D7; border-bottom: 1px solid #0097D7; }
        .footer-link-blue {
            color: #0097D7; text-decoration: none; font-weight: bold; transition: opacity 0.2s;
        }
        .footer-link-blue:hover { opacity: 0.8; text-decoration: underline; }
        .copyright-warning { 
            margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee; 
            font-size: 12px; color: #aaa; font-style: italic; line-height: 1.5;
        }

        @media (max-width: 600px) {
            .controls { flex-direction: column; align-items: stretch; gap: 12px; padding: 20px; }
            .input-group, .btn-group-vertical { width: 100%; max-width: 100%; }
            .btn-base { height: 48px; font-size: 16px; }
            .navbar { font-size: 18px; padding: 14px 0; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">JCI Logo Generator</nav>

    <div class="controls">
        <div class="input-group">
            <label>分會名稱 (Line 1)</label>
            <input type="text" id="chapterInput1" value="Dayuan" oninput="updatePreview()">
            <div id="lengthWarning" class="warning-msg">
                <strong>⚠️ 文字過長 (Point 4)</strong><br>
                已超出盾牌右緣範圍<br>
                <hr class="warning-divider">
                <strong>⚠️ Text too long</strong><br>
                Exceeds the shield's right edge.
            </div>
        </div>
        <div class="input-group">
            <label>分會名稱 (Line 2, 選填)</label>
            <input type="text" id="chapterInput2" value="" oninput="updatePreview()">
        </div>
        <div class="input-group">
            <label>Logo 樣式</label>
            <select id="logoSelect" onchange="updatePreview()">
                <option value="New JCI Logo (SVG)_Primary.svg|#ffffff|jci-blue">Primary (白底藍字)</option>
                <option value="New JCI Logo (SVG)_Secondary - White on JCI Blue.svg|#0097D7|white">Blue Background (藍底白字)</option>
                <option value="New JCI Logo (SVG).svg|#1c1f2a|white">Dark Background (深底白字)</option>
                <option value="New JCI Logo (SVG)_Secondary - Inverted Color on JCI Black.svg|#000000|white">Inverted (黑底白字)</option>
                <option value="New JCI Logo (SVG)_Secondary - JCI Black.svg|#ffffff|black">Black Text (白底黑字)</option>
            </select>
        </div>
        <div class="input-group">
            <label>PNG 品質</label>
            <select id="sizeSelect">
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="3" selected>3x</option>
                <option value="5">5x</option>
            </select>
        </div>
        
        <div class="btn-group-vertical">
            <button class="btn-base btn-png" onclick="generatePNG()">PNG 圖片 (預覽/社群)</button>
            <button class="btn-base btn-svg" onclick="downloadVector('svg')">SVG 向量檔 (設計/轉框)</button>
            <button class="btn-base btn-eps" onclick="downloadVector('eps')">EPS 印刷檔 (CMYK/出版)</button>
        </div>
    </div>

    <div class="preview-container" id="previewBox">
        <div id="error-box"></div>
        
        <div id="svg-preview-box">正在載入字型與圖片...</div>

        <img id="finalResultImg" alt="Generated Logo">
    </div>

    <div class="footer">
        <div class="footer-block">
            Designed & Developed by 
            <a href="https://www.facebook.com/zhenhui.lin/" target="_blank" class="footer-link-blue">Chenghui Lin</a><br>
            (2023 President, JCI Dayuan)
        </div>
        <div class="footer-block">
            <a href="https://www.jcidayuan.site/" target="_blank" class="footer-link">桃園市大園國際青年商會</a> 
            <a href="https://www.facebook.com/zhenhui.lin/" target="_blank" class="footer-link-blue">2023年會長 林振暉</a> 製作<br>
            Copyright &copy; 2026 Chenghui Lin. All rights reserved.
        </div>
        <div class="copyright-warning">
            本程式由 2023 大園青商 林振暉 會長為服務 JCI 夥伴免費開發。<br>
            歡迎廣泛使用，惟請尊重原創開發者成果，請勿私自盜用、修改或宣稱為個人作品。
        </div>
    </div>

    <script>
        // 全局變數：儲存載入的字型與目前的 SVG 代碼
        let currentFont = null;
        let currentSvgString = ""; 

        // 1. 初始化：載入字型
        window.onload = function() {
            opentype.load('PlusJakartaSans-Bold.ttf', function(err, font) {
                if (err) {
                    showError("字型載入失敗！請確認 'PlusJakartaSans-Bold.ttf' 檔案存在於資料夾中。");
                } else {
                    currentFont = font;
                    updatePreview(); // 字型載入完成後，執行第一次預覽
                }
            });
        };

        // 2. 顯示錯誤訊息的輔助函式
        function showError(msg) {
            var errBox = document.getElementById('error-box');
            errBox.style.display = 'block';
            errBox.innerHTML = '<strong>❌ 錯誤：</strong>' + msg;
        }

        // 3. 核心功能：更新預覽畫面 (解決圖片跑版問題)
        async function updatePreview() {
            if (!currentFont) return; // 如果字型還沒載入好，先不做事
            
            // 隱藏錯誤框、隱藏上次的結果圖
            document.getElementById('error-box').style.display = 'none';
            document.getElementById('finalResultImg').style.display = 'none';
            document.getElementById('svg-preview-box').style.display = 'block';

            // 取得使用者設定
            var parts = document.getElementById('logoSelect').value.split('|');
            var rawFileName = parts[0];
            // 自動修復檔名編碼 (處理空格)
            var svgUrl = encodeURIComponent(rawFileName).replace(/%2F/g, "/");
            var bgColor = parts[1];
            var colorType = parts[2];
            
            // 設定背景色
            document.getElementById('previewBox').style.backgroundColor = bgColor;

            // 定義文字顏色
            var colors = { 'jci-blue': '#0097D7', 'white': '#FFFFFF', 'black': '#1C1F2A' };
            var textColorHex = colors[colorType] || '#0097D7';

            try {
                // 下載 SVG 原始檔
                const response = await fetch(svgUrl);
                if (!response.ok) throw new Error("無法讀取圖片檔案，請確認檔名是否正確。");
                const svgText = await response.text();

                // 解析 SVG XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(svgText, "image/svg+xml");
                const svgEl = xmlDoc.documentElement;

                // ★★★ 關鍵修復：動態讀取 SVG 的真實尺寸 (viewBox) ★★★
                // 這樣無論您的 SVG 是 1000px 還是 500px，程式都會自動適應，不會跑版
                let viewBox = svgEl.getAttribute('viewBox');
                let width, height;

                if (viewBox) {
                    const vbParts = viewBox.split(/[\s,]+/); // 支援逗號或空格分隔
                    width = parseFloat(vbParts[2]);
                    height = parseFloat(vbParts[3]);
                } else {
                    // 如果 SVG 沒有 viewBox，嘗試讀取 width/height
                    width = parseFloat(svgEl.getAttribute('width')) || 1000;
                    height = parseFloat(svgEl.getAttribute('height')) || 665;
                    // 強制補上 viewBox，確保縮放正常
                    svgEl.setAttribute('viewBox', `0 0 ${width} ${height}`);
                }

                // 計算文字座標 (依照 JCI 規範比例)
                const fontSize = width * 0.08; 
                const textX = width * 0.118;
                // 注意：Opentype 的座標是基準線 (Baseline)，通常比 Top 多一個 fontSize 的距離
                // 我們這裡動態計算，確保位置精準
                const textYStart = (height * 0.662) + fontSize; 
                const line2Y = textYStart + (fontSize * 0.8) + (width * 0.026);

                // 取得使用者輸入的文字
                const text1 = document.getElementById('chapterInput1').value;
                const text2 = document.getElementById('chapterInput2').value;

                // 使用 opentype.js 將文字轉為路徑 (Path)
                const path1 = currentFont.getPath(text1, textX, textYStart, fontSize);
                path1.fill = textColorHex;

                // ★ Point 4 警告檢測 ★
                // 限制文字寬度不能超過畫布的 55%
                const text1Width = currentFont.getAdvanceWidth(text1, fontSize);
                const maxAllowedWidth = width * 0.55;
                if (text1Width > maxAllowedWidth) {
                    document.getElementById('lengthWarning').style.display = 'block';
                } else {
                    document.getElementById('lengthWarning').style.display = 'none';
                }

                // 將路徑轉為 SVG 字串並插入
                const path1Svg = path1.toSVG(2); // 精度設為 2 小數位
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = path1Svg;
                svgEl.appendChild(tempDiv.firstChild);

                // 處理第二行文字
                if (text2.trim() !== "") {
                    const path2 = currentFont.getPath(text2, textX, line2Y, fontSize);
                    path2.fill = textColorHex;
                    tempDiv.innerHTML = path2.toSVG(2);
                    svgEl.appendChild(tempDiv.firstChild);
                }

                // 序列化回字串，更新畫面
                const serializer = new XMLSerializer();
                currentSvgString = serializer.serializeToString(xmlDoc);
                document.getElementById('svg-preview-box').innerHTML = currentSvgString;

            } catch (err) {
                console.error(err);
                showError(err.message);
            }
        }

        // 4. 功能：生成 PNG 圖片 (使用 html2canvas)
        async function generatePNG() {
            var btn = document.querySelector('.btn-png');
            var originalText = btn.innerText;
            btn.innerText = "處理中..."; btn.disabled = true;

            // 隱藏即時預覽，準備顯示結果
            var previewEl = document.getElementById('svg-preview-box');
            var resultImg = document.getElementById('finalResultImg');
            
            // 讀取品質設定
            var qualityScale = parseFloat(document.getElementById('sizeSelect').value);
            // 裝置判斷
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            var finalScale = qualityScale * 2;
            if (isIOS && finalScale > 7) finalScale = 7; // iOS 記憶體限制保護

            // 等待一下讓畫面更新
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                // 使用 html2canvas 截圖預覽區
                const canvas = await html2canvas(previewEl, { 
                    backgroundColor: null, 
                    scale: finalScale, 
                    useCORS: true 
                });
                
                const imgData = canvas.toDataURL("image/png");
                
                // 切換顯示模式：隱藏 SVG 編輯器，顯示 PNG 結果圖
                previewEl.style.display = 'none';
                resultImg.src = imgData;
                resultImg.style.display = 'block';

                // 顯示提示訊息
                let msg = "";
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    msg = "✅ 圖片已生成！\n\n請直接「長按」下方的圖片，並選擇「儲存到相簿」。\n(點擊其他地方可恢復編輯)";
                } else {
                    msg = "✅ 圖片已生成！\n\n請在下方的圖片上「按右鍵」，並選擇「另存圖片」來下載。\n(點擊其他地方可恢復編輯)";
                }
                alert(msg);

            } catch (err) {
                console.error(err);
                alert("生成失敗，請重新整理頁面再試。");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        // 5. 功能：下載向量檔 (SVG / EPS)
        function downloadVector(format) {
            if (!currentSvgString) {
                alert("請先等待預覽載入完成。");
                return;
            }

            var btn = document.querySelector(format === 'svg' ? '.btn-svg' : '.btn-eps');
            var originalText = btn.innerText;
            btn.innerText = "打包中..."; btn.disabled = true;

            var fileNameBase = "JCI_Logo_" + document.getElementById('chapterInput1').value;

            if (format === 'svg') {
                // 下載 SVG：直接使用我們運算好的 currentSvgString
                triggerDownload(currentSvgString, fileNameBase + ".svg", "image/svg+xml");
                btn.innerText = originalText; btn.disabled = false;
            } 
            else if (format === 'eps') {
                // 下載 EPS：需要將 SVG 轉為高解析度點陣嵌入 EPS (最安全做法)
                // 1. 建立 Canvas
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var img = new Image();
                
                // 設定高解析度 (EPS 預設給 5 倍清晰度)
                var scale = 5;

                // 將 SVG 轉為 Blob URL 載入 Image
                var svgBlob = new Blob([currentSvgString], {type: "image/svg+xml;charset=utf-8"});
                var url = URL.createObjectURL(svgBlob);

                img.onload = function() {
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 轉 Hex 數據 (PostScript 需要)
                    var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var hexData = "";
                    for(var i=0; i<imgData.data.length; i+=4) {
                        var r = imgData.data[i].toString(16).padStart(2, '0');
                        var g = imgData.data[i+1].toString(16).padStart(2, '0');
                        var b = imgData.data[i+2].toString(16).padStart(2, '0');
                        hexData += r + g + b;
                    }

                    // 組合 EPS 檔案內容
                    const epsContent = `%!PS-Adobe-3.0 EPSF-3.0
%%BoundingBox: 0 0 ${canvas.width} ${canvas.height}
%%Title: JCI Logo Generated
%%Creator: JCI Tool
%%Pages: 1
%%EndComments
/readstring { currentfile exch readhexstring pop } bind def
/picstr ${canvas.width} 3 mul string def
gsave
${canvas.width} ${canvas.height} scale
${canvas.width} ${canvas.height} 8 [${canvas.width} 0 0 -${canvas.height} 0 ${canvas.height}]
{ picstr readstring } false 3
colorimage
${hexData}
grestore
%%EOF`;
                    triggerDownload(epsContent, fileNameBase + ".eps", "application/postscript");
                    URL.revokeObjectURL(url);
                    btn.innerText = originalText; btn.disabled = false;
                };
                img.src = url;
            }
        }

        // 6. 輔助函式：觸發下載
        function triggerDownload(content, filename, mimeType) {
            const blob = new Blob([content], {type: mimeType});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
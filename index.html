<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JCI Logo Generator V2.0 SVG AVAILABLE EDITION</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            var box = document.getElementById('debug-console');
            if(box) {
                box.style.display = 'block';
                box.innerHTML += '<div style="color:red; margin-bottom:5px;">❌ 系統錯誤: ' + msg + ' (Line: ' + line + ')</div>';
            }
            if(document.querySelector('.controls')) document.querySelector('.controls').style.display = 'flex';
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

    <style>
        /* --- 1. 全局定義與重置 --- */
        @font-face { 
            font-family: 'Plus Jakarta Sans'; 
            src: url('PlusJakartaSans-Bold.ttf') format('truetype'); 
            font-weight: bold; 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            color: #333;
        }

        /* --- 2. App 頂部導航列 (Navbar) --- */
        .navbar {
            width: 100%;
            background-color: #0097D7;
            color: white;
            padding: 12px 0;
            text-align: center;
            line-height: 1.3;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-main { font-size: 20px; display: block; }
        .nav-sub { font-size: 14px; opacity: 0.9; letter-spacing: 1px; font-weight: normal; }

        /* --- 3. 操作面板 (Controls Panel) --- */
        .controls { 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
            display: flex; 
            gap: 16px; 
            align-items: flex-end; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            justify-content: center; 
            max-width: 800px;
            width: 90%;
        }
        
        .input-group { display: flex; flex-direction: column; gap: 6px; width: 100%; max-width: 250px; }
        label { font-size: 13px; font-weight: 700; color: #555; margin-left: 2px; }
        input, select { 
            padding: 10px 14px; 
            font-size: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            width: 100%; 
            background-color: #fdfdfd;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: #0097D7; outline: none; }
        
        /* 警告訊息 */
        .warning-msg {
            display: none; 
            color: #dc3545; 
            font-size: 13px; 
            line-height: 1.4;
            margin-top: 6px; 
            background-color: #ffe6e6; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #ffcccc;
        }
        
        /* 按鈕組與下載 */
        .btn-group-vertical { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 250px; }
        
        .btn-base {
            padding: 0 20px; 
            font-size: 15px; 
            font-weight: bold; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            height: 44px; 
            width: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: filter 0.2s;
        }
        .btn-base:hover { filter: brightness(1.1); }
        .btn-base:disabled { background-color: #ccc !important; cursor: wait; }

        .btn-png { background-color: #0097D7; }
        .btn-svg { background-color: #20c997; } 
        
        .btn-hint { font-size: 12px; color: #666; text-align: center; margin-top: -5px; }

        /* --- 4. 預覽區 (Preview Area) --- */
        .preview-container { 
            position: relative; 
            width: 500px; 
            max-width: 90vw; 
            aspect-ratio: 1 / 1; 
            padding: 0; 
            border: none;
            box-shadow: none;
            background-color: transparent; 
            margin: 0 auto; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        #svg-preview-box {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        #svg-preview-box svg { 
            max-width: 100%; max-height: 100%; 
            width: auto; height: auto; display: block; 
            filter: drop-shadow(0px 5px 10px rgba(0,0,0,0.1));
        }

        /* --- 5. 手機版全螢幕 Overlay --- */
        .mobile-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px;
        }
        .mobile-overlay img { max-width: 100%; border: 2px solid white; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .mobile-overlay p { color: white; font-weight: bold; text-align: center; line-height: 1.6; font-size: 16px; margin-bottom: 15px; }
        .close-overlay { padding: 12px 40px; background: #0097D7; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 15px; }
        
        /* 除錯與載入 */
        #debug-console { 
            display: none; width: 90%; max-width: 800px; background: #333; color: #fff; 
            padding: 15px; margin-bottom: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; 
            white-space: pre-wrap; border: 2px solid #ff4444;
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            font-weight: bold; color: #0097D7;
        }

        /* --- 6. 底部 Footer --- */
        .footer { 
            margin-top: auto; 
            padding: 40px 20px; 
            width: 100%; 
            text-align: center; 
            color: #666; 
            font-size: 14px;
            line-height: 1.8; 
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        
        .footer-block { margin-bottom: 15px; } 

        .footer-link {
            color: #333; 
            text-decoration: none;
            font-weight: bold;
            border-bottom: 1px dotted #999; 
            transition: color 0.2s, border-bottom 0.2s;
        }
        .footer-link:hover { color: #0097D7; border-bottom: 1px solid #0097D7; }

        .footer-link-blue {
            color: #0097D7; 
            text-decoration: none;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .footer-link-blue:hover { opacity: 0.8; text-decoration: underline; }

        .copyright-warning { 
            margin-top: 20px; 
            padding-top: 15px;
            border-top: 1px dashed #eee; 
            font-size: 12px; 
            color: #aaa; 
            font-style: italic; 
            line-height: 1.5;
        }
    </style>
</head>
<body>

    <div id="loading-overlay"><div>正在讀取資源...</div></div>

    <nav class="navbar">
        <span class="nav-main">JCI Logo Generator V2.0</span>
        <span class="nav-sub">SVG AVAILABLE EDITION</span>
    </nav>

    <div id="debug-console">系統初始化中...</div>

    <div class="controls">
        <div class="input-group">
            <label>分會名稱 / Chapter Name (Line 1)</label>
            <input type="text" id="chapterInput1" value="Dayuan" oninput="updatePreview()">
            <div id="lengthWarning" class="warning-msg">
                ⚠️ 文字過長 (超出盾牌右緣)<br>
                <span style="font-size:12px; color:#c82333;">⚠️ Text too long (Exceeds shield edge)</span>
            </div>
        </div>
        <div class="input-group">
            <label>分會名稱 / Chapter Name (Line 2)</label>
            <input type="text" id="chapterInput2" value="" placeholder="(選填)" oninput="updatePreview()">
        </div>
        <div class="input-group">
            <label>Logo 樣式 / Style</label>
            <select id="logoSelect" onchange="updatePreview()">
                <option value="New JCI Logo (SVG)_Primary.svg|none|jci-blue|transparent">Primary (白底藍字)</option>
                <option value="New JCI Logo (SVG)_Secondary - White on JCI Blue.svg|none|white|transparent">Blue Background (藍底白字)</option>
                <option value="New JCI Logo (SVG).svg|#1c1f2a|white|jci-black">Dark Background (去背全白)</option>
                <option value="New JCI Logo (SVG)_Secondary - Inverted Color on JCI Black.svg|#1c1f2a|white|transparent">Inverted (黑底白字)</option>
                <option value="New JCI Logo (SVG)_Secondary - JCI Black.svg|none|pure-black|transparent">Black Text (全黑)</option>
            </select>
        </div>
        <div class="input-group">
            <label>檔案大小 / File Size</label>
            <select id="sizeSelect">
                <option value="1">小 / Small (1000px)</option>
                <option value="3" selected>中 / Medium (3000px)</option>
                <option value="5">大 / Large (5000px)</option>
            </select>
        </div>
        
        <div class="btn-group-vertical">
            <button class="btn-base btn-png" onclick="downloadFile('png')">下載 PNG 圖片 / Download PNG</button>
            <div class="btn-hint">(Transparent Background)</div>
            <button class="btn-base btn-svg" onclick="downloadFile('svg')">下載 SVG 向量 / Download SVG</button>
            <div class="btn-hint">(Outlined Text / Vector)</div>
        </div>
    </div>

    <div class="preview-container" id="previewContainer">
        <div id="svg-preview-box">正在載入字型資源...</div>
    </div>

    <div class="footer">
        <div class="footer-block">
            Designed & Developed by 
            <a href="https://www.facebook.com/zhenhui.lin/" target="_blank" class="footer-link-blue">Chenghui Lin</a><br>
            (2023 President, JCI Dayuan)
        </div>
        <div class="footer-block">
            <a href="https://www.jcidayuan.site/" target="_blank" class="footer-link">桃園市大園國際青年商會</a> 
            <a href="https://www.facebook.com/zhenhui.lin/" target="_blank" class="footer-link-blue">2023年會長 林振暉</a> 製作<br>
            Copyright &copy; 2026 Chenghui Lin. All rights reserved.
        </div>
        <div class="copyright-warning">
            本程式由 2023 大園青商 林振暉 會長為服務 JCI 夥伴免費開發。<br>
            歡迎廣泛使用，惟請尊重原創開發者成果，請勿私自盜用、修改或宣稱為個人作品。
        </div>
    </div>

    <script>
        // --- 核心配置 (完全保留原始座標與參數) ---
        const LOGO_CONFIG = {
            baseWidth: 1000, 
            line1: { xPercent: 11.8, yPercent: 64.8, sizePx: 81, spacing: -0.3 },
            line2: { xPercent: 11.8, yPercent: 73.6, sizePx: 81, spacing: -0.3 }
        };

        let currentFont = null;
        let svgForDownload = "";

        function log(msg) {
            const box = document.getElementById('debug-console');
            if(box) {
                box.style.display = 'block';
                box.innerHTML += '<div>> ' + msg + '</div>';
            }
            console.log(msg);
        }

        window.onload = function() {
            // 基礎安全性檢查
            if (window.location.protocol === 'file:') {
                log("⚠️ 警告：請使用 GitHub Pages 或 Local Server。");
                alert("Please use Local Server or GitHub Pages.\n直接開啟檔案會導致圖片無法讀取！");
                return;
            }

            // 載入字型
            opentype.load('PlusJakartaSans-Bold.ttf', function(err, font) {
                if (err) {
                    log("❌ 字型載入錯誤: 找不到 'PlusJakartaSans-Bold.ttf'");
                } else {
                    currentFont = font;
                    document.getElementById('loading-overlay').style.display = 'none';
                    updatePreview();
                }
            });
        };

        // --- 核心渲染邏輯 (逐字 Glyphs 渲染以保留 Kerning) ---
        async function updatePreview() {
            if (!currentFont) return;
            
            const parts = document.getElementById('logoSelect').value.split('|');
            const fileName = parts[0], bgToRemove = parts[1], colorType = parts[2], uiBgMode = parts[3];

            // 預覽區容器填色修正
            const pc = document.getElementById('previewContainer');
            pc.style.backgroundColor = (uiBgMode === 'jci-black') ? '#1C1F2A' : 'transparent';

            // 顏色定義 (包含 Pure Black)
            const colors = { 'jci-blue': '#0097D7', 'white': '#FFFFFF', 'black': '#1C1F2A', 'pure-black': '#000000' };
            const textColor = colors[colorType] || '#0097D7';

            try {
                const resp = await fetch(fileName);
                if (!resp.ok) throw new Error("SVG 載入失敗: " + fileName);
                const rawSvg = await resp.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(rawSvg, "image/svg+xml");
                const svgEl = doc.documentElement;

                // 處理預覽時的去背邏輯
                svgEl.querySelectorAll('path, rect, polygon, circle').forEach(el => {
                    const fill = el.getAttribute('fill');
                    if (fill && fill.toLowerCase() === bgToRemove.toLowerCase()) {
                        // Inverted 模式預覽時「不要」移除背景，否則看不見白字
                        if (!(fileName.includes("Inverted") && bgToRemove === '#1c1f2a')) el.style.display = 'none';
                    }
                    // Style 3：預覽容器已補色，故 SVG 內部的背景要移除
                    if (uiBgMode === 'jci-black' && fill && fill.toLowerCase() === '#1c1f2a') el.style.display = 'none';
                });

                // 尺寸標準化 (ViewBox 處理)
                let width = 1000, height = 665;
                if (svgEl.hasAttribute('viewBox')) {
                    const vb = svgEl.getAttribute('viewBox').split(/[\s,]+/);
                    width = parseFloat(vb[2]); height = parseFloat(vb[3]);
                }
                const scaleFactor = width / LOGO_CONFIG.baseWidth;

                const t1 = document.getElementById('chapterInput1').value;
                const t2 = document.getElementById('chapterInput2').value;

                // 高階文字渲染函式
                const createAdvancedPath = (text, config) => {
                    if (!text) return "";
                    const startX = width * (config.xPercent / 100);
                    const fontSize = config.sizePx * scaleFactor;
                    const baselineY = (height * (config.yPercent / 100)) + fontSize;
                    const extraSpacing = (config.spacing || 0) * scaleFactor;

                    const combinedPath = new opentype.Path();
                    let cursorX = startX;
                    const glyphs = currentFont.stringToGlyphs(text);

                    for (let i = 0; i < glyphs.length; i++) {
                        const glyph = glyphs[i];
                        combinedPath.extend(glyph.getPath(cursorX, baselineY, fontSize));
                        cursorX += (glyph.advanceWidth * (fontSize / currentFont.unitsPerEm));
                        if (i < glyphs.length - 1) {
                            cursorX += currentFont.getKerningValue(glyph, glyphs[i + 1]) * (fontSize / currentFont.unitsPerEm);
                        }
                        cursorX += extraSpacing;
                    }
                    combinedPath.fill = textColor;
                    return combinedPath.toSVG(2);
                };

                // 將文字路徑注入 SVG
                const g = doc.createElementNS("http://www.w3.org/2000/svg", "g");
                g.innerHTML = createAdvancedPath(t1, LOGO_CONFIG.line1) + createAdvancedPath(t2, LOGO_CONFIG.line2);
                svgEl.appendChild(g);

                // 序列化顯示
                svgForDownload = new XMLSerializer().serializeToString(svgEl);
                document.getElementById('svg-preview-box').innerHTML = svgForDownload;

                // 長度警告偵測
                const w1 = currentFont.getAdvanceWidth(t1, LOGO_CONFIG.line1.sizePx * scaleFactor);
                document.getElementById('lengthWarning').style.display = (w1 > width * 0.55) ? 'block' : 'none';

            } catch (err) {
                log("❌ 渲染失敗: " + err.message);
            }
        }

        // --- 下載處理邏輯 (手機 Safari Overlay / PNG 去背) ---
        async function downloadFile(type) {
            if (!svgForDownload) return;
            const name = "JCI_" + (document.getElementById('chapterInput1').value || "Logo").replace(/[^a-zA-Z0-9]/g, "_");
            const btn = document.querySelector('.btn-' + type), oldText = btn.innerText;
            btn.innerText = "處理中..."; btn.disabled = true;

            try {
                let svgProcessed = svgForDownload;
                const parts = document.getElementById('logoSelect').value.split('|');
                const bgToRemove = parts[1];

                // PNG 下載強制執行「JCI BLACK (#1C1F2A)」去背
                if (type === 'png' && bgToRemove !== 'none') {
                    const doc = new DOMParser().parseFromString(svgProcessed, "image/svg+xml");
                    doc.querySelectorAll('rect, path, polygon').forEach(el => {
                        const fill = el.getAttribute('fill');
                        // 精確剔除背景色或純黑
                        if (fill && (fill.toLowerCase() === '#1c1f2a' || fill.toLowerCase() === '#000000' || fill.toLowerCase() === 'black')) {
                            el.remove();
                        }
                    });
                    svgProcessed = new XMLSerializer().serializeToString(doc.documentElement);
                }

                // 強制注入 XML Namespace
                if (!svgProcessed.includes('xmlns=')) {
                    svgProcessed = svgProcessed.replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" ');
                }

                if (type === 'svg') {
                    // SVG 下載保留背景 (符合需求)
                    const blob = new Blob([svgProcessed], {type: "image/svg+xml;charset=utf-8"});
                    triggerDL(URL.createObjectURL(blob), name + ".svg");
                } else {
                    // PNG 下載 (Canvas 繪圖)
                    const scale = parseInt(document.getElementById('sizeSelect').value);
                    const img = new Image();
                    const url = URL.createObjectURL(new Blob([svgProcessed], {type: "image/svg+xml;charset=utf-8"}));

                    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

                    const vbMatch = svgProcessed.match(/viewBox="([^"]+)"/);
                    const vb = vbMatch ? vbMatch[1].split(/[\s,]+/) : [0, 0, 1000, 665];
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = parseFloat(vb[2]) * scale; 
                    canvas.height = parseFloat(vb[3]) * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);

                    const pngData = canvas.toDataURL("image/png");
                    
                    // 手機端 (iOS/Android) 顯示長按提示層
                    if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        const overlay = document.createElement('div');
                        overlay.className = 'mobile-overlay';
                        overlay.innerHTML = `
                            <p>圖片已生成！<br>請長按下方圖片並選擇「儲存圖片」</p>
                            <img src="${pngData}">
                            <button class="close-overlay" onclick="this.parentElement.remove()">完成並返回</button>
                        `;
                        document.body.appendChild(overlay);
                    } else { 
                        // 電腦版直接下載
                        triggerDL(pngData, name + ".png"); 
                    }
                }
            } catch (e) { 
                log("❌ 下載錯誤: " + e.message); 
            } finally { 
                btn.innerText = oldText; btn.disabled = false; 
            }
        }

        function triggerDL(url, name) {
            const a = document.createElement('a'); 
            a.href = url; a.download = name; 
            document.body.appendChild(a); a.click(); 
            document.body.removeChild(a); 
        }
    </script>
</body>
</html>
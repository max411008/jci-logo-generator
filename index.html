<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JCI Logo Generator v3.0</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            // å¿½ç•¥ ResizeObserver çš„è‰¯æ€§éŒ¯èª¤
            if (msg.indexOf('ResizeObserver') !== -1) return;
            console.log('ç³»çµ±è¨Šæ¯: ' + msg);
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

    <style>
        /* ==========================================================================
           1. å­—é«”å®šç¾© (Fonts)
           ä½¿ç”¨é–‹æºå­—é«” Plus Jakarta Sans èˆ‡ Noto Sans TCï¼Œç¢ºä¿ç‰ˆæ¬Šåˆæ³•
           ========================================================================== */
        @font-face { 
            font-family: 'Plus Jakarta Sans'; 
            src: url('PlusJakartaSans-Bold.ttf') format('truetype'); 
            font-weight: bold; 
        }
        @font-face { 
            font-family: 'Arial Bold'; 
            src: url('arialbd.ttf') format('truetype'); 
            font-weight: bold; 
        }
        @font-face { 
            font-family: 'Noto Sans TC'; 
            src: url('NotoSansTC-Bold.ttf') format('truetype'); 
            font-weight: bold; 
        }
        
        /* ==========================================================================
           2. å…¨åŸŸåŸºç¤æ¨£å¼ (Global Styles)
           ========================================================================== */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            color: #333;
        }

        /* ==========================================================================
           3. å°è¦½åˆ— (Navbar)
           ========================================================================== */
        .navbar {
            width: 100%; 
            background-color: #0097D7; 
            color: white;
            padding: 12px 0; 
            text-align: center; 
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            margin-bottom: 20px;
            position: sticky; 
            top: 0; 
            z-index: 100;
        }
        .nav-main { 
            font-size: 20px; 
            display: block; 
        }
        .nav-sub { 
            font-size: 13px; 
            opacity: 0.9; 
            letter-spacing: 1px; 
            font-weight: normal; 
        }

        /* ==========================================================================
           4. è¼‰å…¥ç•«é¢ (Loading Overlay)
           ========================================================================== */
        #loading-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(255,255,255,0.98); 
            z-index: 999;
            display: flex; 
            justify-content: center; 
            align-items: center;
            flex-direction: column; 
            font-weight: bold; 
            color: #0097D7;
        }

        /* ==========================================================================
           5. æ§åˆ¶é¢æ¿å€å¡Š (Controls)
           ========================================================================== */
        .controls { 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            margin-bottom: 20px; 
            max-width: 600px; 
            width: 90%;
        }

        .mode-switch-container {
            display: flex; 
            background: #f1f3f5; 
            padding: 4px; 
            border-radius: 8px;
        }
        .mode-btn {
            flex: 1; 
            padding: 10px; 
            text-align: center; 
            cursor: pointer;
            font-weight: bold; 
            border-radius: 6px; 
            color: #666; 
            transition: all 0.3s ease; 
            font-size: 14px;
        }
        .mode-btn.active { 
            background-color: #0097D7; 
            color: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }

        .input-stack {
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            width: 100%;
        }
        
        .input-group { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            width: 100%; 
        }
        
        label { 
            font-size: 13px; 
            font-weight: 700; 
            color: #555; 
            margin-left: 2px; 
            display: flex; 
            justify-content: space-between; 
        }
        
        input, select { 
            padding: 12px; 
            font-size: 16px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            width: 100%; 
            background-color: #fdfdfd;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { 
            border-color: #0097D7; 
            outline: none; 
        }
        
        .warning-msg {
            display: none; 
            color: #dc3545; 
            font-size: 12px; 
            margin-top: 4px;
            background-color: #fff5f5; 
            padding: 8px; 
            border-radius: 4px; 
            border: 1px solid #ffcccc;
        }
        
        /* ==========================================================================
           6. æŒ‰éˆ•æ¨£å¼ (Buttons)
           ========================================================================== */
        .btn-group-vertical { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            width: 100%; 
            margin-top: 10px; 
        }
        .btn-base {
            padding: 0 20px; 
            font-size: 15px; 
            font-weight: bold; 
            color: white;
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            height: 48px; 
            width: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: filter 0.2s;
        }
        .btn-base:hover { filter: brightness(1.1); }
        .btn-base:disabled { background-color: #ccc !important; cursor: wait; }
        
        .btn-png { background-color: #0097D7; }
        .btn-svg { background-color: #20c997; } 
        
        .btn-hint { 
            font-size: 12px; 
            color: #888; 
            text-align: center; 
            margin-top: -5px; 
        }

        /* ==========================================================================
           7. é è¦½å€æ¨£å¼ (Preview Area)
           ========================================================================== */
        .preview-wrapper {
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto;
            text-align: center;
        }
        .preview-label {
            font-size: 12px; 
            color: #888; 
            margin-bottom: 5px; 
            font-weight: bold; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .preview-container { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 1000 / 665;
            border: 1px solid #eee; 
            background-color: #fff; 
            box-sizing: border-box; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }
        #svg-preview-box { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #svg-preview-box svg { 
            width: 100%; 
            height: 100%; 
            display: block; 
        }

        /* ==========================================================================
           8. Footer æ¨£å¼
           ========================================================================== */
        .footer { 
            margin-top: auto; 
            padding: 40px 20px; 
            width: 100%; 
            text-align: center; 
            color: #666; 
            font-size: 13px; 
            line-height: 1.6; 
            border-top: 1px solid #eee; 
            background: white; 
        }
        .footer-link-blue { 
            color: #0097D7; 
            text-decoration: none; 
            font-weight: bold; 
        }

        /* ==========================================================================
           9. Modal å½ˆå‡ºè¦–çª—æ¨£å¼ (é€šç”¨æ–¼é–‹ç™¼æ—¥èªŒèˆ‡åœ–ç‰‡é è¦½)
           ========================================================================== */
        .modal-overlay {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.7); 
            z-index: 2000;
            justify-content: center; 
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; 
            width: 90%; 
            max-width: 600px; 
            max-height: 85vh;
            border-radius: 12px; 
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            overflow-y: auto; 
            position: relative;
            font-family: 'Noto Sans TC', sans-serif; 
            text-align: left;
        }
        .modal-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #eee; 
            padding-bottom: 15px; 
            margin-bottom: 15px;
        }
        .modal-title { 
            font-size: 20px; 
            font-weight: bold; 
            color: #0097D7; 
        }
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            color: #999; 
            cursor: pointer; 
        }
        .close-btn:hover { color: #333; }
        
        /* æ—¥èªŒå…§å®¹æ¨£å¼ */
        .log-entry { margin-bottom: 20px; }
        .log-date { 
            font-size: 12px; 
            color: #888; 
            font-weight: bold; 
            margin-bottom: 4px; 
            display: block;
        }
        .log-ver { 
            font-size: 16px; 
            font-weight: bold; 
            color: #333; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .log-tag { 
            font-size: 11px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            color: white; 
            vertical-align: middle; 
        }
        .tag-feat { background: #20c997; } 
        .tag-init { background: #6c757d; } 
        .tag-fix { background: #ffc107; color: #333; }
        
        .log-desc { 
            margin-top: 5px; 
            font-size: 14px; 
            color: #555; 
            line-height: 1.6; 
        }
        .log-desc ul { 
            margin: 5px 0 0 20px; 
            padding: 0; 
        }
        .log-desc li { margin-bottom: 3px; }

        /* åœ–ç‰‡ä¸‹è¼‰é è¦½æç¤ºæ¨£å¼ */
        .save-hint { 
            text-align: center; 
            padding: 10px; 
            background: #e3f2fd; 
            border-radius: 8px; 
            color: #0d47a1; 
            font-weight: bold; 
            margin-bottom: 15px; 
        }
        
        /* æ‰‹æ©Ÿç‰ˆ Overlay æ¨£å¼ (V2.0 é‚è¼¯) */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            text-align: center;
        }
        .mobile-overlay img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .mobile-overlay p {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .mobile-overlay .close-overlay {
            padding: 12px 30px;
            background: #0097D7;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,151,215,0.3);
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div>ç³»çµ±è¼‰å…¥ä¸­...<br><span style="font-size:12px;color:#999">Loading Fonts... (2 files)</span></div>
    </div>

    <nav class="navbar">
        <span class="nav-main">JCI Logo Generator v3.0</span>
        <span class="nav-sub">Official & Safe Font Edition</span>
    </nav>

    <div class="controls">
        <div class="mode-switch-container">
            <div id="mode-world" class="mode-btn active" onclick="switchMode('world')">ğŸŒ ä¸–ç•Œç¸½æœƒç‰ˆ (World)</div>
            <div id="mode-taiwan" class="mode-btn" onclick="switchMode('taiwan')">ğŸ‡¹ğŸ‡¼ å°ç£ç¸½æœƒç‰ˆ (Taiwan)</div>
        </div>

        <div class="input-stack">
            <div class="input-group">
                <label id="label-line1">åˆ†æœƒåç¨± (Line 1)</label>
                <input type="text" id="chapterInput1" value="Dayuan" oninput="updatePreview()">
                <div id="lengthWarning" class="warning-msg">âš ï¸ æ–‡å­—éé•· (è¶…å‡ºç›¾ç‰Œç¯„åœ)</div>
            </div>
            
            <div class="input-group">
                <label id="label-line2">åˆ†æœƒåç¨± (Line 2, é¸å¡«)</label>
                <input type="text" id="chapterInput2" value="" placeholder="(é¸å¡«)" oninput="updatePreview()">
            </div>

            <div style="display:flex; gap:10px;">
                <div class="input-group" style="flex:1">
                    <label>æ¨£å¼ / Style</label>
                    <select id="logoSelect" onchange="updatePreview()">
                        <option value="New JCI Logo (SVG)_Primary.svg|none|jci-blue|transparent">Primary (ç™½åº•è—å­—)</option>
                        <option value="New JCI Logo (SVG)_Secondary - White on JCI Blue.svg|none|white|transparent">Blue Background (è—åº•ç™½å­—)</option>
                        <option value="New JCI Logo (SVG).svg|#1c1f2a|white|jci-black">Dark Background (å»èƒŒå…¨ç™½)</option>
                        <option value="New JCI Logo (SVG)_Secondary - Inverted Color on JCI Black.svg|#1c1f2a|white|transparent">Inverted (é»‘åº•ç™½å­—)</option>
                        <option value="New JCI Logo (SVG)_Secondary - JCI Black.svg|none|pure-black|transparent">Black Text (å…¨é»‘)</option>
                    </select>
                </div>
                <div class="input-group" style="flex:1">
                    <label>å¤§å° / Size</label>
                    <select id="sizeSelect">
                        <option value="1">å° (1x)</option>
                        <option value="3" selected>ä¸­ (3x)</option>
                        <option value="5">å¤§ (5x)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="btn-group-vertical">
            <button class="btn-base btn-png" onclick="downloadFile('png')">ä¸‹è¼‰ PNG åœ–ç‰‡</button>
            <div class="btn-hint">(Transparent Background)</div>
            <button class="btn-base btn-svg" onclick="downloadFile('svg')">ä¸‹è¼‰ SVG å‘é‡</button>
            <div class="btn-hint">(Vector / Outlined Text)</div>
        </div>
    </div>

    <div class="preview-wrapper">
        <div class="preview-label">â–¼ é è¦½å€ (Preview Area) â–¼</div>
        <div class="preview-container" id="previewContainer">
            <div id="svg-preview-box"></div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-block">
            Designed & Developed by 
            <a href="https://www.facebook.com/zhenhui.lin/" target="_blank" class="footer-link-blue">Chenghui Lin</a>
            <br>
            (2023 President, JCI Dayuan)
        </div>
        <div class="footer-block">
            <a href="https://www.jcidayuan.site/" target="_blank" class="footer-link-blue">æ¡ƒåœ’å¸‚å¤§åœ’åœ‹éš›é’å¹´å•†æœƒ</a> è£½ä½œ
        </div>
        <div style="margin-top: 15px; font-size: 12px;">
            <a href="javascript:void(0)" onclick="openModal('devLog')" style="color:#0097D7; text-decoration:none; border-bottom:1px dashed #0097D7; font-weight:bold;">
                ğŸ“œ æŸ¥çœ‹é–‹ç™¼æ—¥èªŒ (Changelog)
            </a>
        </div>
    </div>

    <div id="devLogModal" class="modal-overlay" onclick="closeModal(event, 'devLog')">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">ğŸš€ é–‹ç™¼æ¼”é€²æ—¥èªŒ</div>
                <button class="close-btn" onclick="closeModalBtn('devLog')">Ã—</button>
            </div>
            <div class="modal-content">
                <div class="log-entry">
                    <span class="log-date">2026/01/15 - Present</span>
                    <div class="log-ver"><span class="log-tag tag-feat">V3.0</span> å®Œæ•´åŠŸèƒ½ç™¼å¸ƒ</div>
                    <div class="log-desc">
                        å°ˆç‚ºå°ç£ç¸½æœƒé‡èº«æ‰“é€ çš„åœ¨åœ°åŒ–ç‰ˆæœ¬ï¼Œé›†æˆäº†æ™ºæ…§æ’ç‰ˆã€å•†ç”¨å­—é«”èˆ‡è¡Œå‹•è£ç½®å„ªåŒ–ã€‚
                        <ul>
                            <li><strong>ğŸ‡¹ğŸ‡¼ å°ç£ç¸½æœƒç‰ˆï¼š</strong>å¯¦ä½œç¨æœ‰çš„é›™è¡Œæ’ç‰ˆï¼Œä¸¦é‡å°ä¸­è‹±æ–‡æ¡ç”¨ç¨ç«‹åº§æ¨™ç³»çµ±ï¼Œç¢ºä¿åƒç´ ç´šå°é½Šã€‚</li>
                            <li><strong>ğŸ“± è¡Œå‹•è£ç½®æ”¯æ´ï¼š</strong>ä¿®å¾© LINE èˆ‡ Safari å…§å»ºç€è¦½å™¨çš„ä¸‹è¼‰å•é¡Œï¼Œæ–°å¢åœ–ç‰‡é è¦½å½ˆçª—ã€‚</li>
                            <li><strong>âš–ï¸ åˆè¦æ€§å‡ç´šï¼š</strong>å…¨é¢æ¡ç”¨ <strong>Plus Jakarta Sans</strong> (ä¸–ç•Œç¸½æœƒè¦å®šä¹‹å­—é«”) èˆ‡ <strong>Noto Sans TC</strong> (ä¸­æ–‡)ï¼Œç¢ºä¿ 100% ç‰ˆæ¬Šåˆæ³•ã€‚</li>
                            <li><strong>Smart Layout å¼•æ“ï¼š</strong>é–‹ç™¼ç´…ç·šæ¼”ç®—æ³•ï¼Œæ–‡å­—éé•·è‡ªå‹•ç¸®å°ï¼Œç¢ºä¿ä¸è¶…å‡ºç›¾ç‰Œé‚Šç•Œï¼›ä¸¦å…·å‚™åˆ†æ•£å°é½ŠåŠŸèƒ½ã€‚</li>
                        </ul>
                    </div>
                </div>
                
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                
                <div class="log-entry">
                    <span class="log-date">2026/01/08</span>
                    <div class="log-ver"><span class="log-tag tag-feat">V2.0</span> å‘é‡é©å‘½</div>
                    <div class="log-desc">
                        ç‚ºäº†æ‡‰å°å¤§å‹è¼¸å‡ºéœ€æ±‚ï¼Œæ¨æ£„ Canvas æ”¹æ¡ SVG æŠ€è¡“é‡å¯«æ ¸å¿ƒã€‚
                        <ul>
                            <li><strong>é›™æ ¼å¼è¼¸å‡ºï¼š</strong>æ–°å¢ .svg å‘é‡æª”ä¸‹è¼‰ï¼Œæ”¯æ´ AI ç·¨è¼¯ã€‚</li>
                            <li><strong>ç•«è³ªæå‡ï¼š</strong>è§£æ±º PNG é‚Šç·£é‹¸é½’å•é¡Œï¼Œå¯¦ç¾ç„¡é™æ”¾å¤§ä¸å¤±çœŸã€‚</li>
                        </ul>
                    </div>
                </div>
                
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                
                <div class="log-entry">
                    <span class="log-date">2025/12/04</span>
                    <div class="log-ver"><span class="log-tag tag-init">V1.0</span> åŸå‹èª•ç”Ÿ</div>
                    <div class="log-desc">
                        å¿«é€Ÿè§£æ±ºæœƒå‹æ‰¾ä¸åˆ°å»èƒŒ Logo æˆ–é¡è‰²éŒ¯èª¤çš„ç—›é»ã€‚
                        <ul>
                            <li>å…§å»º JCI å®˜æ–¹ 5 ç¨®æ¨™æº–é…è‰²ã€‚</li>
                            <li>æ”¯æ´å³æ™‚åœ–ç‰‡ç”Ÿæˆ (PNG)ã€‚</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top:20px; text-align:center; color:#ccc; font-size:12px;">
                    Developed with â¤ï¸ by JCI Dayuan
                </div>
            </div>
        </div>
    </div>

    <div id="imagePreviewModal" class="modal-overlay" onclick="closeModal(event, 'imagePreview')">
        <div class="modal-box" style="text-align:center;">
            <div class="modal-header">
                <div class="modal-title">åœ–ç‰‡å·²å»ºç«‹</div>
                <button class="close-btn" onclick="closeModalBtn('imagePreview')">Ã—</button>
            </div>
            <div class="save-hint">ğŸ‘‡ è«‹ã€Œé•·æŒ‰åœ–ç‰‡ã€é¸æ“‡å„²å­˜è‡³ç›¸ç°¿</div>
            <img id="generatedImage" src="" style="max-width:100%; border-radius:8px; border:1px solid #ddd; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
            <div style="margin-top:15px;">
                <button class="btn-base btn-png" onclick="closeModalBtn('imagePreview')">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------
        // 1. CONFIG è¨­å®šæª” (V3.0 Final)
        // ----------------------------------------
        const CONFIG = {
            baseWidth: 1000,
            
            // ä¸–ç•Œç¸½æœƒç‰ˆ
            world: {
                line1: { xPercent: 11.8, yPercent: 64.8, sizePx: 81, spacing: -0.3 },
                line2: { xPercent: 11.8, yPercent: 73.6, sizePx: 81, spacing: -0.3 },
                defaultText1: "Dayuan",
                defaultText2: ""
            },

            // å°ç£ç¸½æœƒç‰ˆ (åš´æ ¼é–å®šåƒæ•¸)
            taiwan: {
                // è‹±æ–‡ Line 1
                line1: { 
                    startX: 11.829, 
                    limitX: 74.8, 
                    yPercent: 65.9, 
                    sizePx: 74 
                },
                // ä¸­æ–‡ Line 2
                line2: { 
                    startX: 12.2, 
                    limitX: 75.2, 
                    yPercent: 75.0, 
                    sizePx: 56 
                },
                
                defaultText1: "Dayuan,Taiwan",
                defaultText2: "æ¡ƒåœ’å¸‚å¤§åœ’åœ‹éš›é’å¹´å•†æœƒ"
            }
        };

        let currentMode = 'world'; 
        let fontWorld = null; // Plus Jakarta Sans (å–ä»£ Arial)
        let fontTwCh = null;  // Noto Sans TC
        let svgForDownload = "";

        // ----------------------------------------
        // 2. Modal è¦–çª—æ§åˆ¶
        // ----------------------------------------
        function openModal(type) { 
            const id = type === 'devLog' ? 'devLogModal' : 'imagePreviewModal';
            document.getElementById(id).style.display = 'flex'; 
            document.body.style.overflow = 'hidden'; 
        }
        function closeModalBtn(type) { 
            const id = type === 'devLog' ? 'devLogModal' : 'imagePreviewModal';
            document.getElementById(id).style.display = 'none'; 
            document.body.style.overflow = 'auto'; 
        }
        function closeModal(e, type) { 
            const id = type === 'devLog' ? 'devLogModal' : 'imagePreviewModal';
            if (e.target.id === id) closeModalBtn(type); 
        }

        // ----------------------------------------
        // 3. åˆå§‹åŒ–èˆ‡å­—é«”è¼‰å…¥ (Window Onload)
        // ----------------------------------------
        window.onload = function() {
            let loadedCount = 0; 
            const totalFonts = 2; // åªéœ€è¼‰å…¥å…©å€‹åˆæ³•å­—é«”
            const statusBox = document.querySelector('#loading-overlay div');

            const updateStatus = (fontName, success) => {
                loadedCount++;
                const icon = success ? 'âœ…' : 'âŒ';
                statusBox.innerHTML = `
                    ç³»çµ±è¼‰å…¥ä¸­...<br>
                    <span style="font-size:12px;color:#666">
                        Progress: ${loadedCount} / ${totalFonts}<br>
                        ${icon} ${fontName} ${success ? 'Ready' : 'Failed'}
                    </span>
                `;

                if(loadedCount >= totalFonts) { 
                    setTimeout(() => { 
                        document.getElementById('loading-overlay').style.display = 'none'; 
                        switchMode('world'); 
                    }, 500); 
                }
            };

            // 1. Plus Jakarta Sans (World & Taiwan English)
            opentype.load('PlusJakartaSans-Bold.ttf', function(err, font) { 
                if (err) updateStatus('PlusJakartaSans', false); 
                else { fontWorld = font; updateStatus('PlusJakartaSans', true); }
            });

            // 2. Noto Sans TC (Taiwan Chinese)
            opentype.load('NotoSansTC-Bold.ttf', function(err, font) { 
                if (err) updateStatus('NotoSansTC', false); 
                else { fontTwCh = font; updateStatus('NotoSansTC', true); }
            });
        };

        // ----------------------------------------
        // 4. æ¨¡å¼åˆ‡æ› (Switch Mode)
        // ----------------------------------------
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');

            const settings = CONFIG[mode];
            document.getElementById('chapterInput1').value = settings.defaultText1;
            document.getElementById('chapterInput2').value = settings.defaultText2;

            if(mode === 'taiwan') {
                document.getElementById('label-line1').innerText = "åˆ†æœƒè‹±æ–‡åç¨± (English)";
                document.getElementById('label-line2').innerText = "åˆ†æœƒä¸­æ–‡åç¨± (Chinese)";
                document.getElementById('lengthWarning').style.display = 'none';
            } else {
                document.getElementById('label-line1').innerText = "åˆ†æœƒåç¨± (Line 1)";
                document.getElementById('label-line2').innerText = "åˆ†æœƒåç¨± (Line 2)";
            }
            updatePreview();
        }

        // ----------------------------------------
        // 5. æ›´æ–°é è¦½ (Update Preview) - æ ¸å¿ƒç¹ªåœ–é‚è¼¯
        // ----------------------------------------
        async function updatePreview() {
            // ä½¿ç”¨ Plus Jakarta Sans ä½œç‚ºä¸–ç•Œç‰ˆèˆ‡å°ç£ç‰ˆçš„è‹±æ–‡å­—é«”
            const fWorld = fontWorld; 
            const fTwEn = fontWorld; 
            const fTwCh = fontTwCh;

            if (!fWorld && !fTwCh) return;
            
            const parts = document.getElementById('logoSelect').value.split('|');
            const fileName = parts[0], bgToRemove = parts[1], colorType = parts[2], uiBgMode = parts[3];

            document.getElementById('previewContainer').style.backgroundColor = (uiBgMode === 'jci-black') ? '#1C1F2A' : 'transparent';
            const colors = { 'jci-blue': '#0097D7', 'white': '#FFFFFF', 'black': '#1C1F2A', 'pure-black': '#000000' };
            const textColor = colors[colorType] || '#0097D7';

            try {
                const resp = await fetch(fileName);
                if (!resp.ok) throw new Error("SVG è¼‰å…¥å¤±æ•—");
                const rawSvg = await resp.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(rawSvg, "image/svg+xml");
                const svgEl = doc.documentElement;

                svgEl.querySelectorAll('path, rect, polygon, circle').forEach(el => {
                    const fill = el.getAttribute('fill');
                    if (fill && fill.toLowerCase() === bgToRemove.toLowerCase()) { 
                        if (!(fileName.includes("Inverted") && bgToRemove === '#1c1f2a')) el.style.display = 'none'; 
                    }
                    if (uiBgMode === 'jci-black' && fill && fill.toLowerCase() === '#1c1f2a') el.style.display = 'none';
                });

                let width = 1000, height = 665;
                if (svgEl.hasAttribute('viewBox')) { 
                    const vb = svgEl.getAttribute('viewBox').split(/[\s,]+/); 
                    width = parseFloat(vb[2]); height = parseFloat(vb[3]); 
                }
                const scaleFactor = width / CONFIG.baseWidth;

                const t1 = document.getElementById('chapterInput1').value;
                const t2 = document.getElementById('chapterInput2').value;
                const settings = CONFIG[currentMode];

                const g = doc.createElementNS("http://www.w3.org/2000/svg", "g");

                if (currentMode === 'world') {
                    // ä¸–ç•Œç‰ˆç¹ªåœ–
                    const p1 = createStandardPath(t1, settings.line1, fWorld, width, height, scaleFactor, textColor);
                    const p2 = createStandardPath(t2, settings.line2, fWorld, width, height, scaleFactor, textColor);
                    g.innerHTML = p1 + p2;

                    if(fWorld) {
                        const w1 = fWorld.getAdvanceWidth(t1, settings.line1.sizePx * scaleFactor);
                        document.getElementById('lengthWarning').style.display = (w1 > width * 0.55) ? 'block' : 'none';
                    }
                } else {
                    // å°ç£ç‰ˆç¹ªåœ– (ç¨ç«‹åº§æ¨™ + Smart Fit)
                    document.getElementById('lengthWarning').style.display = 'none';
                    
                    const l1Start = width * (settings.line1.startX / 100);
                    const l1Limit = width * (settings.line1.limitX / 100);
                    const l1Target = l1Limit - l1Start;
                    
                    const l2Start = width * (settings.line2.startX / 100);
                    const l2Limit = width * (settings.line2.limitX / 100);
                    const l2Target = l2Limit - l2Start;

                    const p1 = createSmartFitPath(t1, settings.line1, fTwEn, l1Start, height, scaleFactor, l1Target, textColor);
                    const p2 = createSmartFitPath(t2, settings.line2, fTwCh, l2Start, height, scaleFactor, l2Target, textColor);

                    g.innerHTML = p1 + p2;
                }

                svgEl.appendChild(g);
                svgForDownload = new XMLSerializer().serializeToString(svgEl);
                document.getElementById('svg-preview-box').innerHTML = svgForDownload;

            } catch (err) { console.error(err); }
        }

        // ----------------------------------------
        // 6. å­—é«”è·¯å¾‘ç”¢ç”Ÿå™¨ (Path Generators)
        // ----------------------------------------
        function createStandardPath(text, config, font, width, height, scale, color) {
            if (!text || !font) return "";
            const startX = width * (config.xPercent / 100);
            const fontSize = config.sizePx * scale;
            const baselineY = (height * (config.yPercent / 100)) + fontSize;
            return generatePathString(text, font, startX, baselineY, fontSize, (config.spacing || 0) * scale, color);
        }

        function createSmartFitPath(text, config, font, startX, height, scale, targetWidth, color) {
            if (!text || !font) return "";
            const stdFontSize = config.sizePx * scale;
            const rawWidth = font.getAdvanceWidth(text, stdFontSize);
            let finalFontSize = stdFontSize; 
            let finalSpacing = 0;

            if (rawWidth < targetWidth) {
                // åˆ†æ•£å°é½Šé‚è¼¯ (Dispersion)
                const gap = targetWidth - rawWidth;
                const charCount = text.length;
                if (charCount > 1) { finalSpacing = gap / (charCount - 1); }
            } else {
                // è‡ªå‹•ç¸®æ”¾é‚è¼¯ (Auto Scale)
                const ratio = targetWidth / rawWidth;
                finalFontSize = stdFontSize * ratio;
            }
            const baselineY = (height * (config.yPercent / 100)) + stdFontSize; 
            return generatePathString(text, font, startX, baselineY, finalFontSize, finalSpacing, color);
        }

        function generatePathString(text, font, x, y, fontSize, spacing, color) {
            const combinedPath = new opentype.Path();
            let cursorX = x;
            const glyphs = font.stringToGlyphs(text);

            for (let i = 0; i < glyphs.length; i++) {
                const glyph = glyphs[i];
                combinedPath.extend(glyph.getPath(cursorX, y, fontSize));
                cursorX += (glyph.advanceWidth * (fontSize / font.unitsPerEm));
                if (i < glyphs.length - 1) { 
                    cursorX += font.getKerningValue(glyph, glyphs[i + 1]) * (fontSize / font.unitsPerEm); 
                }
                cursorX += spacing;
            }
            combinedPath.fill = color;
            return combinedPath.toSVG(2);
        }

        // ----------------------------------------
        // 7. æª”æ¡ˆä¸‹è¼‰é‚è¼¯ (Fix for LINE/Safari)
        // ----------------------------------------
        async function downloadFile(type) {
            if (!svgForDownload) return;
            const name = "JCI_" + (document.getElementById('chapterInput1').value || "Logo").replace(/[^a-zA-Z0-9]/g, "_");
            const btn = document.querySelector('.btn-' + type), oldText = btn.innerText;
            btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿ (åŒ…å« iOS/Android/LINE In-App)
            const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);

            try {
                let svgProcessed = svgForDownload;
                const parts = document.getElementById('logoSelect').value.split('|');
                const bgToRemove = parts[1];

                // è™•ç† PNG é€æ˜èƒŒæ™¯
                if (type === 'png' && bgToRemove !== 'none') {
                    const doc = new DOMParser().parseFromString(svgProcessed, "image/svg+xml");
                    doc.querySelectorAll('rect, path, polygon').forEach(el => {
                        const fill = el.getAttribute('fill');
                        if (fill && (fill.toLowerCase() === '#1c1f2a' || fill.toLowerCase() === '#000000' || fill.toLowerCase() === 'black')) el.remove();
                    });
                    svgProcessed = new XMLSerializer().serializeToString(doc.documentElement);
                }
                // è£œä¸Š xmlns é¿å…éŒ¯èª¤
                if (!svgProcessed.includes('xmlns=')) { 
                    svgProcessed = svgProcessed.replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" '); 
                }

                if (type === 'svg') {
                    // SVG ç›´æ¥ä¸‹è¼‰
                    const blob = new Blob([svgProcessed], {type: "image/svg+xml;charset=utf-8"});
                    triggerDL(URL.createObjectURL(blob), name + ".svg");
                } else {
                    // PNG ç”Ÿæˆé‚è¼¯
                    const scale = parseInt(document.getElementById('sizeSelect').value);
                    const img = new Image();
                    const url = URL.createObjectURL(new Blob([svgProcessed], {type: "image/svg+xml;charset=utf-8"}));
                    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

                    const vbMatch = svgProcessed.match(/viewBox="([^"]+)"/);
                    const vb = vbMatch ? vbMatch[1].split(/[\s,]+/) : [0, 0, 1000, 665];
                    const canvas = document.createElement('canvas');
                    canvas.width = parseFloat(vb[2]) * scale; 
                    canvas.height = parseFloat(vb[3]) * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    const pngData = canvas.toDataURL("image/png");

                    if (isMobile) {
                        // â˜… LINE/Safari ä¿®å¾©ï¼šæ”¹ç‚ºå½ˆå‡º Modal é è¦½ï¼Œä¸é–‹æ–°è¦–çª—
                        // ä½¿ç”¨ V2.0 é¢¨æ ¼çš„ Mobile Overlay
                        const overlay = document.createElement('div');
                        overlay.className = 'mobile-overlay';
                        overlay.innerHTML = `
                            <p style="font-weight:bold; color:#0097D7; font-size:18px;">åœ–ç‰‡å·²ç”Ÿæˆï¼</p>
                            <p>è«‹ã€Œé•·æŒ‰ä¸‹æ–¹åœ–ç‰‡ã€ä¸¦é¸æ“‡ã€Œå„²å­˜åœ–ç‰‡ã€<br>(Long press image to save)</p>
                            <img src="${pngData}">
                            <button class="close-overlay" onclick="this.parentElement.remove()">å®Œæˆä¸¦è¿”å› (Close)</button>
                        `;
                        document.body.appendChild(overlay);
                    } else { 
                        // é›»è…¦ç‰ˆç›´æ¥ä¸‹è¼‰
                        triggerDL(pngData, name + ".png"); 
                    }
                }
            } catch (e) { 
                console.error(e); 
                alert("éŒ¯èª¤: " + e.message); 
            } finally { 
                btn.innerText = oldText; btn.disabled = false; 
            }
        }

        function triggerDL(url, name) {
            const a = document.createElement('a'); a.href = url; a.download = name; 
            document.body.appendChild(a); a.click(); document.body.removeChild(a); 
            if(url.startsWith('blob:')) setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
    </script>
</body>
</html>